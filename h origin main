warning: in the working copy of 'accident-report/js/accident-report.js', LF will be replaced by CRLF the next time Git touches it
[1mdiff --git a/accident-report/js/accident-report.js b/accident-report/js/accident-report.js[m
[1mindex 5c0a6fa..38f2eb8 100644[m
[1m--- a/accident-report/js/accident-report.js[m
[1m+++ b/accident-report/js/accident-report.js[m
[36m@@ -1,12 +1,16 @@[m
[31m-// äº‹æ•…å ±å‘Šãƒ•ã‚©ãƒ¼ãƒ  JavaScript - URLSearchParams + ç”»è³ªæ”¹å–„ç‰ˆ v20250728001[m
[32m+[m[32mï»¿// äº‹æ•…å ±å‘Šãƒ•ã‚©ãƒ¼ãƒ  JavaScript - URLSearchParams + ç”»è³ªæ”¹å–„ç‰ˆ v20250728001[m
 [m
 // è¨­å®š[m
 const config = {[m
     woffId: 'k7_SVZ1p8vy45jQkIRvOUw', // æœ¬ç•ªç’°å¢ƒã®WOFF ID[m
[31m-    gasUrl: 'https://script.google.com/macros/s/AKfycby5fRaVu5vISA3dvflBAaYXtWtBGXRyWt9HpWYlAiWbqqHzyBxSAt6vpWn6NuWFk8Gj/exec',[m
[32m+[m[32m   // gasUrl: 'https://script.google.com/macros/s/AKfycbxD9kzCqRreieyw1WDNADsaw_zLsmYGB6pTiue-5Vuw0-2KcViZ4MNM_TtQkeASIkN7OA/exec', // Crutoæ§˜æœ¬ç•ªç’°å¢ƒ[m
[32m+[m[32m    gasUrl: 'https://script.google.com/macros/s/AKfycby5fRaVu5vISA3dvflBAaYXtWtBGXRyWt9HpWYlAiWbqqHzyBxSAt6vpWn6NuWFk8Gj/exec', // æ‘æ¾ãƒ†ã‚¹ãƒˆ[m
[32m+[m
[32m+[m[41m    [m
     googleMapsApiKey: 'AIzaSyCdhA4t8flujiYex2OddJCkFv4u6nWvi9w' // Google Maps Geocoding API[m
 };[m
 [m
[32m+[m
 // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°[m
 let formData = {};[m
 let photoData = {[m
[36m@@ -60,6 +64,13 @@[m [mdocument.addEventListener('DOMContentLoaded', async function() {[m
         // ã¾ãšæœ€åˆã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šï¼ˆãƒ•ã‚©ãƒ¼ãƒ æ“ä½œã‚’å³åº§ã«æœ‰åŠ¹åŒ–ï¼‰[m
         console.log('âš™ï¸ Setting up event listeners...');[m
         setupEventListeners();[m
[32m+[m[32m        // åˆæœŸçŠ¶æ…‹ã§ã¯å†™çœŸã¯ä»»æ„ï¼ˆäº‹æ•…ç¨®é¡ãŒæœªé¸æŠ or ãã®ä»–ï¼‰[m
[32m+[m[32m        try {[m
[32m+[m[32m            const initialType = document.querySelector('input[name="accidentType"]:checked')?.value;[m
[32m+[m[32m            setScenePhotoRequired(initialType === 'vehicle');[m
[32m+[m[32m        } catch (_) {[m
[32m+[m[32m            // åˆæœŸåŒ–ä¸­ã¯ç„¡è¦–[m
[32m+[m[32m        }[m
         console.log('âœ… Event listeners setup complete');[m
     } catch (eventError) {[m
         console.error('âŒ Event listener setup failed:', eventError);[m
[36m@@ -348,6 +359,8 @@[m [mfunction loadOfficesFromCache() {[m
 [m
 // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š[m
 function setupEventListeners() {[m
[32m+[m[32m    // ã€Œãã®ä»–ã€ç”¨ã®åˆ©ç”¨è€…åãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‹•çš„ã«æŒ¿å…¥[m
[32m+[m[32m    ensureOtherUserNameField();[m
     // äº‹æ•…ç¨®é¡ã®é¸æŠã«ã‚ˆã‚‹è¡¨ç¤ºåˆ‡æ›¿[m
     document.querySelectorAll('input[name="accidentType"]').forEach(radio => {[m
         radio.addEventListener('change', handleAccidentTypeChange);[m
[36m@@ -391,7 +404,7 @@[m [mfunction setupEventListeners() {[m
     // é€ä¿¡ãƒœã‚¿ãƒ³[m
     const submitBtn = document.getElementById('submitBtn');[m
     if (submitBtn) {[m
[31m-        submitBtn.addEventListener('click', showConfirmModal);[m
[32m+[m[32m        submitBtn.addEventListener('click', handleSubmitClick);[m
     }[m
     [m
     // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœã‚¿ãƒ³[m
[36m@@ -403,15 +416,60 @@[m [mfunction setupEventListeners() {[m
     }[m
     [m
     // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¯ãƒªã‚¢[m
[31m-    document.querySelectorAll('input, select, textarea').forEach(element => {[m
[31m-        element.addEventListener('input', function() {[m
[31m-            clearError(this);[m
[32m+[m[32m      document.querySelectorAll('input, select, textarea').forEach(element => {[m
[32m+[m[32m          element.addEventListener('input', function() {[m
[32m+[m[32m              clearError(this);[m
         });[m
         element.addEventListener('change', function() {[m
             clearError(this);[m
         });[m
     });[m
[31m-}[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  // ã€Œãã®ä»–ã€ç™ºç”Ÿå ´æ‰€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åˆ©ç”¨è€…åãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ [m
[32m+[m[32m  function ensureOtherUserNameField() {[m
[32m+[m[32m      try {[m
[32m+[m[32m          const otherSection = document.getElementById('otherLocationSection');[m
[32m+[m[32m          if (!otherSection) return;[m
[32m+[m
[32m+[m[32m          // æ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„[m
[32m+[m[32m          if (document.getElementById('userName')) return;[m
[32m+[m
[32m+[m[32m          const locationCategorySelect = document.getElementById('locationCategory');[m
[32m+[m[32m          const locationGroup = locationCategorySelect && locationCategorySelect.closest('.form-group');[m
[32m+[m
[32m+[m[32m          const wrapper = document.createElement('div');[m
[32m+[m[32m          wrapper.className = 'form-group';[m
[32m+[m[32m          wrapper.innerHTML = [[m
[32m+[m[32m              '<label class="required">åˆ©ç”¨è€…ã®åå‰</label>',[m
[32m+[m[32m              '<input type="text" id="userName" name="userName" placeholder="åˆ©ç”¨è€…ã®æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">',[m
[32m+[m[32m              '<span class="error-message">åˆ©ç”¨è€…ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>'[m
[32m+[m[32m          ].join('');[m
[32m+[m
[32m+[m[32m          if (locationGroup && locationGroup.parentElement === otherSection) {[m
[32m+[m[32m              otherSection.insertBefore(wrapper, locationGroup);[m
[32m+[m[32m          } else {[m
[32m+[m[32m              otherSection.insertBefore(wrapper, otherSection.firstChild);[m
[32m+[m[32m          }[m
[32m+[m[32m      } catch (e) {[m
[32m+[m[32m          console.error('åˆ©ç”¨è€…åãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', e);[m
[32m+[m[32m      }[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  // é€ä¿¡ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆã€Œãã®ä»–ã€ã®åˆ©ç”¨è€…åå¿…é ˆãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ ï¼‰[m
[32m+[m[32m  function handleSubmitClick() {[m
[32m+[m[32m      const accidentTypeInput = document.querySelector('input[name="accidentType"]:checked');[m
[32m+[m[32m      if (accidentTypeInput && accidentTypeInput.value === 'other') {[m
[32m+[m[32m          const userNameField = document.getElementById('userName');[m
[32m+[m[32m          if (userNameField && !userNameField.value) {[m
[32m+[m[32m              showError(userNameField);[m
[32m+[m[32m              alert('åˆ©ç”¨è€…ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');[m
[32m+[m[32m              return;[m
[32m+[m[32m          }[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      showConfirmModal();[m
[32m+[m[32m  }[m
 [m
 // äº‹æ•…ç¨®é¡å¤‰æ›´æ™‚ã®å‡¦ç†[m
 function handleAccidentTypeChange(e) {[m
[36m@@ -453,6 +511,26 @@[m [mfunction handleAccidentTypeChange(e) {[m
         vehiclePhotos.classList.remove('active');[m
         otherLocationSection.style.display = 'block';[m
     }[m
[32m+[m
[32m+[m[32m    // äº‹æ•…ç¨®é¡ã«å¿œã˜ã¦ã€Œäº‹æ•…ç¾å ´ã®å†™çœŸã€ã®å¿…é ˆã‚’åˆ‡ã‚Šæ›¿ãˆ[m
[32m+[m[32m    setScenePhotoRequired(e.target.value === 'vehicle');[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// ã€Œäº‹æ•…ç¾å ´ã®å†™çœŸã€ã‚’å¿…é ˆ/ä»»æ„ã«åˆ‡ã‚Šæ›¿ãˆ[m
[32m+[m[32mfunction setScenePhotoRequired(isRequired) {[m
[32m+[m[32m    const sceneInput = document.getElementById('scenePhoto');[m
[32m+[m[32m    // ãƒ©ãƒ™ãƒ«ã¯ scenePhotoUpload ã®è¦ª(.form-group)å†…ã® <label>[m
[32m+[m[32m    const sceneLabel = document.querySelector('#scenePhotoUpload')?.parentElement?.querySelector('label');[m
[32m+[m[32m    if (!sceneInput) return;[m
[32m+[m[32m    if (isRequired) {[m
[32m+[m[32m        sceneInput.setAttribute('required', 'required');[m
[32m+[m[32m        if (sceneLabel) sceneLabel.classList.add('required');[m
[32m+[m[32m    } else {[m
[32m+[m[32m        sceneInput.removeAttribute('required');[m
[32m+[m[32m        if (sceneLabel) sceneLabel.classList.remove('required');[m
[32m+[m[32m        // ä»»æ„ã«ã—ãŸã¨ãã¯ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’æ¶ˆã™[m
[32m+[m[32m        clearError(sceneInput);[m
[32m+[m[32m    }[m
 }[m
 [m
 // å¯¾ç‰©é¸æŠæ™‚ã®å‡¦ç†[m
[36m@@ -861,7 +939,10 @@[m [mfunction buildReportData(formData, photoData) {[m
         photos: {[m
             scene: photoData.scene || [][m
         }[m
[31m-    };[m
[32m+[m[32m      };[m
[32m+[m[41m      [m
[32m+[m[32m      // ï¿½gï¿½pï¿½lï¿½ï¿½fï¿½[ï¿½^ï¿½É’Ç‰ï¿½[m
[32m+[m[32m      baseData.userName = formData.userName;[m
     [m
     // æ¡ä»¶åˆ†å²ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ [m
     if (formData.accidentType === 'other') {[m
[36m@@ -1158,8 +1239,9 @@[m [mfunction validateForm() {[m
         isValid = false;[m
     }[m
     [m
[31m-    // äº‹æ•…ç¾å ´ã®å†™çœŸãƒã‚§ãƒƒã‚¯[m
[31m-    if (photoData.scene.length === 0) {[m
[32m+[m[32m    // äº‹æ•…ç¾å ´ã®å†™çœŸãƒã‚§ãƒƒã‚¯ï¼ˆè»Šä¸¡äº‹æ•…ã®ã¨ãã®ã¿å¿…é ˆï¼‰[m
[32m+[m[32m    const selectedTypeForPhoto = document.querySelector('input[name="accidentType"]:checked')?.value;[m
[32m+[m[32m    if (selectedTypeForPhoto === 'vehicle' && photoData.scene.length === 0) {[m
         showError(document.getElementById('scenePhoto'));[m
         isValid = false;[m
     }[m
[36m@@ -1377,24 +1459,26 @@[m [masync function submitForm() {[m
         // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å¤‰æ›[m
         const reportData = buildReportData(formData, photoData);[m
         [m
[31m-        // ãƒ‡ãƒãƒƒã‚°: é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª[m
[32m+[m[32m        // ãƒ‡ãƒãƒƒã‚°: é€ä¿¡ãƒ‡ãƒ¼ã‚¿ç¢ºèª[m
[32m+[m[32m        console.log('ğŸšš é€ä¿¡ãƒ‡ãƒ¼ã‚¿ç¢ºèª:', {[m
             scene: photoData.scene?.length || 0,[m
             property: photoData.property?.length || 0,[m
             otherVehicle: photoData.otherVehicle?.length || 0,[m
             ownVehicle: photoData.ownVehicle?.length || 0,[m
             license: photoData.license?.length || 0[m
         });[m
[31m-        [m
[32m+[m
[32m+[m[32m        console.log('ğŸ“ äº‹æ•…å ±å‘Šé€ä¿¡é–‹å§‹:', {[m
[32m+[m[32m            äº‹æ•…ç¨®åˆ¥: reportData.accidentType,[m
[32m+[m[32m            å†™çœŸæšæ•°: totalPhotos,[m
[32m+[m[32m            ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: `${jsonSizeKB}KB`[m
[32m+[m[32m        });[m
[32m+[m
         // ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯[m
         const jsonSize = JSON.stringify(reportData).length;[m
         const jsonSizeKB = (jsonSize / 1024).toFixed(1);[m
         const totalPhotos = Object.values(reportData.photos).flat().length;[m
         [m
[31m-        console.log('ğŸ“ äº‹æ•…å ±å‘Šé€ä¿¡é–‹å§‹:', { [m
[31m-            äº‹æ•…ç¨®é¡: reportData.accidentType, [m
[31m-            å†™çœŸæšæ•°: totalPhotos,[m
[31m-            ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: `${jsonSizeKB}KB`[m
[31m-        });[m
         [m
         // ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºåˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆ5æšã®ç”»åƒã§ã‚‚2MBä»¥å†…ã«åã¾ã‚‹ã‚ˆã†èª¿æ•´ï¼‰[m
         if (jsonSize > 2 * 1024 * 1024) { // 2MBä»¥ä¸Š[m
[36m@@ -1431,6 +1515,7 @@[m [masync function submitForm() {[m
             }[m
         } else if (reportData.accidentType === 'ãã®ä»–') {[m
             // ãã®ä»–äº‹æ•…ã®å ´åˆã®è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰[m
[32m+[m[32m            formDataParams.append('userName', reportData.userName || '');[m
             formDataParams.append('otherAccidentCategory', reportData.otherAccidentCategory || '');[m
             formDataParams.append('locationCategory', reportData.locationCategory || '');[m
             formDataParams.append('locationDetail', reportData.locationDetail || '');[m
[36m@@ -1498,3 +1583,5 @@[m [masync function submitForm() {[m
         sendingMessage.style.display = 'none'; // é€ä¿¡ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º[m
     }[m
 }[m
[41m+[m
[41m+[m
